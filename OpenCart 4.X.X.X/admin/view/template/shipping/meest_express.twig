{{ header }}{{ column_left }}

<div id="content">
  <div class="page-header">
    <div class="container-fluid">
      <div class="float-end">
        <button type="submit" form="form-shipping" data-bs-toggle="tooltip" title="{{ button_save }}" class="btn btn-primary"><i class="fas fa-save"></i></button>
        <a href="{{ cancel }}" data-bs-toggle="tooltip" title="{{ button_cancel }}" class="btn btn-light"><i class="fas fa-reply"></i></a>
      </div>
      <h1>{{ heading_title }}</h1>
      <ol class="breadcrumb">
        {% for breadcrumb in breadcrumbs %}
          <li class="breadcrumb-item"><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
        {% endfor %}
      </ol>
    </div>
  </div>
  <div class="container-fluid">
    {% if error_warning %}
      <div class="alert alert-danger alert-dismissible"><i class="fas fa-exclamation-circle"></i> {{ error_warning }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endif %}
    <div class="card">
      <div class="card-header"><i class="fas fa-pencil-alt"></i> {{ text_edit }}</div>
      <div class="card-body">
        <form id="form-shipping" action="{{ action }}" method="post">
          <ul class="nav nav-tabs" id="shipping-tabs">
            <li class="nav-item"><a href="#tab-setting" data-bs-toggle="tab" class="nav-link active">{{ tab_setting }}</a></li>
            <li class="nav-item"><a href="#tab-database" data-bs-toggle="tab" class="nav-link">{{ tab_database }}</a></li>
            <li class="nav-item"><a href="#tab-sender" data-bs-toggle="tab" class="nav-link">{{ tab_sender }}</a></li>
            <li class="nav-item"><a href="#tab-contract" data-bs-toggle="tab" class="nav-link">{{ tab_contract }}</a></li>
            <li class="nav-item"><a href="#tab-contact" data-bs-toggle="tab" class="nav-link">{{ tab_contact }}</a></li>
            <li class="nav-item"><a href="#tab-help" data-bs-toggle="tab" class="nav-link">{{ tab_help }}</a></li>
          </ul>
          <div class="tab-content">
            <div id="tab-setting" class="tab-pane active">
              <div class="row mb-3">
                <label for="input-tax-class" class="col-sm-2 col-form-label">{{ entry_tax_class }}</label>
                <div class="col-sm-10">
                  <select name="shipping_meest_express_tax_class_id" id="input-tax-class" class="form-select">
                    <option value="0">{{ text_none }}</option>
                    {% for tax_class in tax_classes %}
                      <option value="{{ tax_class.tax_class_id }}" {% if tax_class.tax_class_id == shipping_meest_express_tax_class_id %}selected{% endif %}>{{ tax_class.title }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="row mb-3">
                <label for="input-geo-zone" class="col-sm-2 col-form-label">{{ entry_geo_zone }}</label>
                <div class="col-sm-10">
                  <select name="shipping_meest_express_geo_zone_id" id="input-geo-zone" class="form-select">
                    <option value="0">{{ text_all_zones }}</option>
                    {% for geo_zone in geo_zones %}
                      <option value="{{ geo_zone.geo_zone_id }}" {% if geo_zone.geo_zone_id == shipping_meest_express_geo_zone_id %}selected{% endif %}>{{ geo_zone.name }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="row mb-3">
                <label class="col-sm-2 col-form-label">{{ entry_service }}</label>
                <div class="col-sm-10">
                  <div class="p-3 bg-light rounded">
                    {% for service in services %}
                      <div class="row align-items-center mb-2">
                        <div class="col-md-6">
                          <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="shipping_meest_express_service[]" value="{{ service.value }}" {% if service.value in shipping_meest_express_service %}checked{% endif %}>
                            <label class="form-check-label">{{ service.text }}</label>
                          </div>
                        </div>
                        <div class="col-md-2">
                          <label class="form-label text-center d-block">{{ entry_cost }}</label>
                        </div>
                        <div class="col-md-4">
                          <input type="text" name="shipping_meest_express_cost[{{ service.value }}]" value="{{ shipping_meest_express_cost[service.value] }}" class="form-control" placeholder="{{ entry_cost }}">
                        </div>
                      </div>
                    {% endfor %}
                    <div class="mt-2">
                      <button type="button" onclick="$(this).closest('.col-sm-10').find(':checkbox').prop('checked', true);" class="btn btn-link btn-sm">{{ text_select_all }}</button> /
                      <button type="button" onclick="$(this).closest('.col-sm-10').find(':checkbox').prop('checked', false);" class="btn btn-link btn-sm">{{ text_unselect_all }}</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <label class="col-sm-2 col-form-label" for="input-calculation-in-checkout">{{ calculation_in_checkout }}</label>
                <div class="col-sm-10">
                  <div class="form-check form-switch">
                    <input type="checkbox" class="form-check-input" id="input-calculation-in-checkout" name="shipping_meest_express_calculation_in_checkout" value="1" {% if shipping_meest_express_calculation_in_checkout %}checked{% endif %}>
                    <label class="form-check-label" for="input-calculation-in-checkout"></label>
                  </div>
                  <div class="alert alert-info mt-2">
                    <i class="fas fa-info-circle"></i> {{ calculation_in_checkout_info }}
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <label for="input-status" class="col-sm-2 col-form-label">{{ entry_status }}</label>
                <div class="col-sm-10">
                  <select name="shipping_meest_express_status" id="input-status" class="form-select">
                    <option value="1" {% if shipping_meest_express_status %}selected{% endif %}>{{ text_enabled }}</option>
                    <option value="0" {% if not shipping_meest_express_status %}selected{% endif %}>{{ text_disabled }}</option>
                  </select>
                </div>
              </div>
              <div class="row mb-3">
                <label for="input-auth-mode" class="col-sm-2 col-form-label">{{ entry_auth_mode }}</label>
                <div class="col-sm-10">
                  <select name="shipping_meest_express_auth_mode" id="input-auth-mode" class="form-select">
                    <option value="default" {% if shipping_meest_express_auth_mode == 'default' %}selected{% endif %}>Default (Login/Password)</option>
                    <option value="api_key" {% if shipping_meest_express_auth_mode == 'api_key' %}selected{% endif %}>Token</option>
                  </select>
                </div>
              </div>
              <div id="token-description" class="alert alert-info" style="display: none;">
                <h6><i class="fas fa-info-circle"></i> Інструкція для отримання Token</h6>
                <ul class="mb-0">
                  <li>Зареєструйтесь в Особистому кабінеті за посиланням <a href="https://24.meest.com" target="_blank">https://24.meest.com</a>.</li>
                  <li>Натисніть в боковому меню на кнопку Налаштування.</li>
                  <li>Перейдіть на вкладку API інтеграції.</li>
                  <li>Натисніть кнопку Укласти договір і в результаті Ви отримаєте token.</li>
                </ul>
              </div>
              <div id="auth-default" class="row mb-3" {% if shipping_meest_express_auth_mode != 'default' %} style="display: none;" {% endif %}>
                <label for="input-login" class="col-sm-2 col-form-label">{{ entry_login }}</label>
                <div class="col-sm-10">
                  <input type="text" name="shipping_meest_express_login" value="{{ shipping_meest_express_login }}" id="input-login" class="form-control" placeholder="{{ entry_login }}">
                </div>
              </div>
              <div class="row mb-3" {% if shipping_meest_express_auth_mode != 'default' %} style="display: none;" {% endif %}>
                <label for="input-password" class="col-sm-2 col-form-label">{{ entry_password }}</label>
                <div class="col-sm-10">
                  <input type="password" name="shipping_meest_express_password" value="{{ shipping_meest_express_password }}" id="input-password" class="form-control" placeholder="{{ entry_password }}">
                </div>
              </div>
              <div id="auth-api-key" class="row mb-3" {% if shipping_meest_express_auth_mode != 'api_key' %} style="display: none;" {% endif %}>
                <label for="input-api-key" class="col-sm-2 col-form-label">{{ entry_api_key }}</label>
                <div class="col-sm-10">
                  <input type="text" name="shipping_meest_express_api_key" value="{{ shipping_meest_express_api_key }}" id="input-api-key" class="form-control" placeholder="{{ entry_api_key }}">
                  {% if error_api_key %}
                    <div class="text-danger">{{ error_api_key }}</div>
                  {% endif %}
                  <div class="alert alert-info mt-2">
                    <h6>Для отримання ключа (token) виконайте наступні кроки:</h6>
                    <ul class="mb-0">
                      <li>Зареєструйтесь в Особистому кабінеті за посиланням <a href="https://24.meest.com" target="_blank">https://24.meest.com</a>.</li>
                      <li>Натисніть в боковому меню на кнопку Налаштування.</li>
                      <li>Перейдіть на вкладку API інтеграції.</li>
                      <li>Натисніть кнопку Укласти договір і в результаті Ви отримаєте token.</li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <label for="input-sort-order" class="col-sm-2 col-form-label">{{ entry_sort_order }}</label>
                <div class="col-sm-10">
                  <input type="text" name="shipping_meest_express_sort_order" value="{{ shipping_meest_express_sort_order }}" id="input-sort-order" class="form-control" placeholder="{{ entry_sort_order }}">
                </div>
              </div>
              <div class="row mb-3">
                <label class="col-sm-2 col-form-label" for="input-free-shipping-enabled">{{ entry_free_shipping_enabled }}</label>
                <div class="col-sm-10">
                  <div class="form-check form-switch">
                    <input type="checkbox" class="form-check-input" id="input-free-shipping-enabled" name="shipping_meest_express_free_shipping_enabled" value="1" {% if shipping_meest_express_free_shipping_enabled %}checked{% endif %}>
                    <label class="form-check-label" for="input-free-shipping-enabled"></label>
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <label for="input-free-shipping-threshold" class="col-sm-2 col-form-label">{{ entry_free_shipping_threshold }}</label>
                <div class="col-sm-10">
                  <input type="text" name="shipping_meest_express_free_shipping_threshold" value="{{ shipping_meest_express_free_shipping_threshold }}" id="input-free-shipping-threshold" class="form-control" placeholder="{{ entry_free_shipping_threshold }}">
                  <div class="form-text">{{ help_free_shipping_threshold }}</div>
                </div>
              </div>
            </div>

            <div id="tab-database" class="tab-pane">
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead>
                  <tr>
                    <th>{{ entry_type_of_data }}</th>
                    <th>{{ entry_last_updated }}</th>
                    <th>{{ entry_amount }}</th>
                    <th>{{ entry_description }}</th>
                    <th>{{ entry_action }}</th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr>
                    <td>Region</td>
                    <td>{{ regions_import_info.latest_date }}</td>
                    <td>{{ regions_import_info.total }}</td>
                    <td>It will be updated regions list of the Meest company. The action will not affect the standard regions</td>
                    <td>
                      <button type="button" onclick="updateRegions()" id="button-update_region" class="btn btn-primary btn-sm">
                        <i class="fas fa-sync-alt"></i> {{ button_refresh }}
                      </button>
                    </td>
                  </tr>
                  <tr>
                    <td>City</td>
                    <td>{{ cities_import_info.latest_date }}</td>
                    <td>{{ cities_import_info.total }}</td>
                    <td>It will be updated cities in which can be delivered by the Meest company</td>
                    <td>
                      <button type="button" onclick="updateCities()" id="button-update_city" class="btn btn-primary btn-sm">
                        <i class="fas fa-sync-alt"></i> {{ button_refresh }}
                      </button>
                    </td>
                  </tr>
                  <tr>
                    <td>Branch</td>
                    <td>{{ branch_import_info.latest_date }}</td>
                    <td>{{ branch_import_info.total }}</td>
                    <td>It will be updated branches of the Meest company</td>
                    <td>
                      <button type="button" id="button-update_branch" class="btn btn-primary btn-sm" onclick="return confirm('This operation may take three hours. Are you impressed?') ? updateBranches() : false;">
                        <i class="fas fa-sync-alt"></i> {{ button_refresh }}
                      </button>
                    </td>
                  </tr>
                  <tr>
                    <td>Streets</td>
                    <td>{{ streets_import_info.latest_date }}</td>
                    <td>{{ streets_import_info.total }}</td>
                    <td>It will be updated streets of the Meest company</td>
                    <td>
                      <button type="button" onclick="updateStreets()" id="button-update_street" class="btn btn-primary btn-sm">
                        <i class="fas fa-sync-alt"></i> {{ button_refresh }}
                      </button>
                    </td>
                  </tr>
                  </tbody>
                </table>
              </div>


              <div class="custom-table">
                <div class="alert alert-info mb-0" style="white-space: nowrap; overflow: auto;">
                  <strong style="margin-right: 6px;">Cron command:</strong>
                  <code style="white-space: nowrap;">{{ cron_command }}</code>
                </div>
              </div>


            </div>

            <div id="tab-sender" class="tab-pane">
              <div class="row mb-3">
                <label for="input-sender-contract-id" class="col-sm-2 col-form-label">{{ entry_contract_id }}</label>
                <div class="col-sm-10">
                  <select name="shipping_meest_express_sender_contract_id" id="input-sender-contract-id" class="form-select">
                    <option value="">{{ text_select_contract }}</option>
                    {% for contract in contracts %}
                      <option value="{{ contract.contractID }}" {% if contract.contractID == shipping_meest_express_sender_contract_id %}selected{% endif %}>{{ contract.contractID }}</option>
                    {% endfor %}
                  </select>
                </div>
                    </div>
              <div class="row mb-3">
                <label for="input-sender-contact-person" class="col-sm-2 col-form-label">{{ entry_sender_contact_person }}</label>
                <div class="col-sm-10">
                  <select name="shipping_meest_express_sender_contact_person" id="input-sender-contact-person" class="form-select">
                    <option value="">{{ text_select }}</option>
                    {% for contact in contacts %}
                      <option value="{{ contact.id }}" {% if contact.id == shipping_meest_express_sender_contact_person %}selected{% endif %}>{{ contact.firstname }} {{ contact.lastname }} {{ contact.middlename }} - {{ contact.phone }}</option>
                    {% endfor %}
                  </select>
                    </div>
                    </div>
              <div class="row mb-3">
                <label for="input-sender-region" class="col-sm-2 col-form-label">{{ entry_sender_region }}</label>
                <div class="col-sm-10">
                  <select name="shipping_meest_express_sender_region" id="input-sender-region" class="form-select">
                    <option value="">{{ text_select }}</option>
                    {% for region in regions %}
                      <option value="{{ region.region_id }}" {% if region.region_id == shipping_meest_express_sender_region %}selected{% endif %}>{{ region.region_name_ua }}</option>
                    {% endfor %}
                  </select>
                    </div>
                  </div>
              <div class="row mb-3">
                <label for="input-sender-city" class="col-sm-2 col-form-label">{{ entry_sender_city }}</label>
                <div class="col-sm-10">
                  <select name="shipping_meest_express_sender_city" id="input-sender-city" class="form-select">
                    <option value="">{{ text_select }}</option>
                  </select>
                </div>
              </div>
              <div class="row mb-3">
                <label for="input-sender-address" class="col-sm-2 col-form-label">{{ entry_sender_street }}</label>
                <div class="col-sm-10">
                  <select name="shipping_meest_express_sender_address" id="input-sender-address" class="form-select">
                    <option value="">{{ text_select }}</option>
                  </select>
              </div>
            </div>
              <div class="row mb-3">
                <label for="input-sender-branch" class="col-sm-2 col-form-label">{{ entry_branch }}</label>
                <div class="col-sm-10">
                  <select name="shipping_meest_express_sender_branch" id="input-sender-branch" class="form-select">
                    <option value="">{{ text_select }}</option>
                  </select>
                </div>
              </div>
            </div>

            <div id="tab-contract" class="tab-pane">
              <div class="row mb-3">
                <label for="input-contract-id" class="col-sm-2 col-form-label">{{ text_contract_id }}</label>
                <div class="col-sm-10">
                  <input type="text" name="contract_id" id="input-contract-id" class="form-control" placeholder="{{ text_enter_contract_id }}">
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-sm-offset-2 col-sm-10">
                  <button type="button" id="button-add-contract" class="btn btn-primary">{{ button_add_contract }}</button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead>
                  <tr>
                    <th>{{ column_contract_id }}</th>
                    <th>{{ column_date_created }}</th>
                    <th>{{ column_date_updated }}</th>
                    <th>{{ column_action }}</th>
                  </tr>
                  </thead>
                  <tbody>
                  {% if contracts %}
                    {% for contract in contracts %}
                      <tr>
                        <td>{{ contract.contractID }}</td>
                        <td>{{ contract.creatеd_at }}</td>
                        <td>{{ contract.updated_at }}</td>
                        <td>
                          <button type="button" data-contract-id="{{ contract.id }}" class="btn btn-danger btn-sm delete-contract">{{ button_delete }}</button>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="4" class="text-center">{{ text_no_contracts }}</td>
                    </tr>
                  {% endif %}
                  </tbody>
                </table>
              </div>
            </div>

            <div id="tab-contact" class="tab-pane">
              <div class="row mb-3">
                <label for="input-phone" class="col-sm-2 col-form-label">{{ text_phone }}</label>
                <div class="col-sm-10">
                  <input type="text" name="phone" id="input-phone" class="form-control" placeholder="{{ text_enter_phone }}">
                </div>
              </div>
              <div class="row mb-3">
                <label for="input-firstname" class="col-sm-2 col-form-label">{{ text_firstname }}</label>
                <div class="col-sm-10">
                  <input type="text" name="firstname" id="input-firstname" class="form-control" placeholder="{{ text_enter_firstname }}">
                </div>
              </div>
              <div class="row mb-3">
                <label for="input-lastname" class="col-sm-2 col-form-label">{{ text_lastname }}</label>
                <div class="col-sm-10">
                  <input type="text" name="lastname" id="input-lastname" class="form-control" placeholder="{{ text_enter_lastname }}">
                </div>
              </div>
              <div class="row mb-3">
                <label for="input-middlename" class="col-sm-2 col-form-label">{{ text_middlename }}</label>
                <div class="col-sm-10">
                  <input type="text" name="middlename" id="input-middlename" class="form-control" placeholder="{{ text_enter_middlename }}">
              </div>
            </div>
              <div class="row mb-3">
                <div class="col-sm-offset-2 col-sm-10">
                  <button type="button" id="button-add-contact" class="btn btn-primary">{{ button_add_contact }}</button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead>
                  <tr>
                    <th>{{ column_phone }}</th>
                    <th>{{ column_firstname }}</th>
                    <th>{{ column_lastname }}</th>
                    <th>{{ column_middlename }}</th>
                    <th>{{ column_action }}</th>
                  </tr>
                  </thead>
                  <tbody>
                  {% if contacts %}
                    {% for contact in contacts %}
                      <tr>
                        <td>{{ contact.phone }}</td>
                        <td>{{ contact.firstname }}</td>
                        <td>{{ contact.lastname }}</td>
                        <td>{{ contact.middlename }}</td>
                        <td>
                          <button type="button" data-contact-id="{{ contact.id }}" class="btn btn-danger btn-sm btn-delete-contact">{{ button_delete }}</button>
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="5" class="text-center">{{ text_no_contacts }}</td>
                    </tr>
                  {% endif %}
                  </tbody>
                </table>
              </div>
            </div>

            <div id="tab-help" class="tab-pane">
              <div class="alert alert-info">
                <h5>{{ help_text_meest }}</h5>
                <p>{{ help_text_about }}</p>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  window.meest2Urls = {
    importBranches: '{{ importBranches }}',
    importRegions: '{{ importRegions }}',
    importCity: '{{ importCity }}',
    importStreets: '{{ importStreets }}',
    addContract: '{{ addContract }}',
    deleteContract: '{{ deleteContract }}',
    addContact: '{{ addContact }}',
    deleteContact: '{{ deleteContact }}',
    ajax_get_cities_url: '{{ ajax_get_cities_url }}',
    ajax_get_addresses_url: '{{ ajax_get_addresses_url }}',
    ajax_get_branches_url: '{{ ajax_get_branches_url }}',
    shipping_meest_express_sender_region: '{{ shipping_meest_express_sender_region }}',
    shipping_meest_express_sender_city: '{{ shipping_meest_express_sender_city }}',
    shipping_meest_express_sender_address: '{{ shipping_meest_express_sender_address }}',
    shipping_meest_express_sender_branch: '{{ shipping_meest_express_sender_branch }}',
    text_update_success: '{{ text_update_success }}',
    text_select: '{{ text_select }}',
    text_error_contract_id: '{{ text_error_contract_id }}',
    text_error_fill_fields: '{{ text_error_fill_fields }}',
    text_confirm_delete: '{{ text_confirm_delete }}'
  };

  // Auth mode toggle
  $('#input-auth-mode').on('change', function() {
    var mode = $(this).val();
    if (mode === 'api_key') {
      $('#auth-default').hide();
      $('#auth-api-key').show();
      $('#token-description').show();
    } else {
      $('#auth-default').show();
      $('#auth-api-key').hide();
      $('#token-description').hide();
    }
  });

  // Initialize on page load
  $(document).ready(function() {
    $('#input-auth-mode').trigger('change');

    // Initialize Select2 for searchable dropdowns
    $('#input-sender-region').select2({
      placeholder: '{{ text_select }}',
      allowClear: true,
      width: '100%'
    });

    $('#input-sender-city').select2({
      placeholder: '{{ text_select }}',
      allowClear: true,
      width: '100%'
    });

    $('#input-sender-address').select2({
      placeholder: '{{ text_select }}',
      allowClear: true,
      width: '100%'
    });

    $('#input-sender-branch').select2({
      placeholder: '{{ text_select }}',
      allowClear: true,
      width: '100%'
    });

    $('#input-sender-contact-person').select2({
      placeholder: '{{ text_select }}',
      allowClear: true,
      width: '100%'
    });

    // Add Contact button handler
    $('#button-add-contact').on('click', function() {
      addContact();
    });

    // Add Contract button handler
    $('#button-add-contract').on('click', function() {
      addContract();
    });

    // Delete contract buttons
    $(document).on('click', '.delete-contract', function() {
      var contractId = $(this).data('contract-id');
      if (contractId) {
        deleteContract(contractId);
      }
    });

    // Delete contact buttons
    $(document).on('click', '.delete-contact', function() {
      var contactId = $(this).data('contact-id');
      deleteContact(contactId);
    });

    // Sender region change handler
    $('#input-sender-region').on('change', function() {
      populateCities($(this).val());
    });

    // Sender city change handler
    $('#input-sender-city').on('change', function() {
      populateAddresses($(this).val());
      populateBranches($(this).val());
    });

    // Initialize on page load if region is already selected
    if ('{{ shipping_meest_express_sender_region }}') {
      populateCities('{{ shipping_meest_express_sender_region }}');
    }
  });

  // Update regions function
  function updateRegions() {
    var button = $('#button-update_region');

    $.ajax({
      url: 'index.php?route=extension/MeestExpress/shipping/meest_express.importRegions&user_token=' + getURLParameter('user_token'),
      type: 'post',
      dataType: 'json',
      beforeSend: function() {
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Loading...');
      },
      complete: function() {

        button.prop('disabled', false).html('<i class="fas fa-sync-alt"></i> Refresh');
      },
      success: function(json) {

        if (json['success']) {

          location.reload();
        } else {
          alert(json['error']);
        }
      },
      error: function(xhr, ajaxOptions, thrownError) {

        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
      }
    });
  }

  // Update cities function
  function updateCities() {
    var button = $('#button-update_city');

    $.ajax({
      url: 'index.php?route=extension/MeestExpress/shipping/meest_express.importCity&user_token=' + getURLParameter('user_token'),
        type: 'post',
        dataType: 'json',
        beforeSend: function() {
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Loading...');
        },
        complete: function() {
        button.prop('disabled', false).html('<i class="fas fa-sync-alt"></i> Refresh');
        },
        success: function(json) {
            if (json['success']) {

          location.reload();
            } else {
                alert(json['error']);
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
  }

  // Update branches function
  function updateBranches() {
    var button = $('#button-update_branch');

    $.ajax({
      url: 'index.php?route=extension/MeestExpress/shipping/meest_express.importBranches&user_token=' + getURLParameter('user_token'),
      type: 'post',
      dataType: 'json',
      beforeSend: function() {
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Loading...');
      },
      complete: function() {
        button.prop('disabled', false).html('<i class="fas fa-sync-alt"></i> Refresh');
      },
      success: function(json) {
        if (json['success']) {

          location.reload();
        } else {
          alert(json['error']);
        }
      },
      error: function(xhr, ajaxOptions, thrownError) {
        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
      }
    });
  }

  // Update streets function
  function updateStreets() {
    var button = $('#button-update_street');

    $.ajax({
      url: 'index.php?route=extension/MeestExpress/shipping/meest_express.importStreets&user_token=' + getURLParameter('user_token'),
        type: 'post',
        dataType: 'json',
        beforeSend: function() {
        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Loading...');
        },
        complete: function() {
        button.prop('disabled', false).html('<i class="fas fa-sync-alt"></i> Refresh');
      },
      success: function(json) {
        if (json['success']) {

          location.reload();
        } else {
          alert(json['error']);
        }
      },
      error: function(xhr, ajaxOptions, thrownError) {
        alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
      }
    });
  }

  // Add contract function
  function addContract() {
    var contractId = $('#input-contract-id').val();
    if (contractId) {
      $.ajax({
        url: 'index.php?route=extension/MeestExpress/shipping/meest_express.addContract&user_token=' + getURLParameter('user_token'),
        type: 'post',
        data: {contract_id: contractId},
        dataType: 'json',
        success: function(json) {
            if (json['success']) {
            alert('Contract added successfully');
            $('#input-contract-id').val('');
            location.reload();
            } else {
                alert(json['error']);
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
    } else {
      alert('Please enter Contract ID');
    }
  }

  // Delete contract function
  function deleteContract(contractId) {
    if (confirm('Are you sure you want to delete this contract?')) {
    $.ajax({
        url: 'index.php?route=extension/MeestExpress/shipping/meest_express.deleteContract&user_token=' + getURLParameter('user_token'),
        type: 'post',
        data: {contract_id: contractId},
        dataType: 'json',
        success: function(json) {
          if (json['success']) {
            alert('Contract deleted successfully');
            location.reload();
          } else {
            alert(json['error']);
          }
        },
        error: function(xhr, ajaxOptions, thrownError) {
          alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
      });
    }
  }

  // Add contact function
  function addContact() {
    var phone = $('#input-phone').val();
    var firstname = $('#input-firstname').val();
    var lastname = $('#input-lastname').val();
    var middlename = $('#input-middlename').val();

    if (phone && firstname && lastname && middlename) {
      $.ajax({
        url: 'index.php?route=extension/MeestExpress/shipping/meest_express.addContact&user_token=' + getURLParameter('user_token'),
        type: 'post',
        data: {
          phone: phone,
          firstname: firstname,
          lastname: lastname,
          middlename: middlename
        },
        dataType: 'json',
        success: function(json) {
            if (json['success']) {
            alert('Contact added successfully');
            location.reload();
            } else {
                alert(json['error']);
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
    } else {
      alert('Please fill all fields');
    }
  }

  // Delete contact function
  function deleteContact(contactId) {
    if (confirm('Are you sure you want to delete this contact?')) {
    $.ajax({
        url: 'index.php?route=extension/MeestExpress/shipping/meest_express.deleteContact&user_token=' + getURLParameter('user_token'),
        type: 'post',
        data: {contact_id: contactId},
        dataType: 'json',
        success: function(json) {
            if (json['success']) {
            alert('Contact deleted successfully');
            location.reload();
            } else {
                alert(json['error']);
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
    });
    }
  }

  // Helper function to get URL parameters
  function getURLParameter(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

  // Populate cities based on region
  function populateCities(region_id) {
    $.get('{{ ajax_get_cities_url }}'.replace(/&amp;/g, '&'), { region_id: region_id }, function(data) {
      const citySelect = $('#input-sender-city');
      
      // Destroy Select2 before updating options
      if (citySelect.hasClass("select2-hidden-accessible")) {
        citySelect.select2('destroy');
      }
      
      citySelect.empty().append('<option value="">{{ text_select }}</option>');
      $.each(data, function(_, city) {
        citySelect.append('<option value="' + city.city_id + '">' + city.name_ua + '</option>');
      });
      
      // Reinitialize Select2
      citySelect.select2({
        placeholder: '{{ text_select }}',
        allowClear: true,
        width: '100%'
      });
      
      if ('{{ shipping_meest_express_sender_city }}') {
        citySelect.val('{{ shipping_meest_express_sender_city }}').trigger('change');
      }
    }, 'json');
  }

  // Populate addresses based on city
  function populateAddresses(city_id) {
    $.get('{{ ajax_get_addresses_url }}'.replace(/&amp;/g, '&'), { city_id: city_id }, function(data) {
      const addressSelect = $('#input-sender-address');
      
      // Destroy Select2 before updating options
      if (addressSelect.hasClass("select2-hidden-accessible")) {
        addressSelect.select2('destroy');
      }
      
      addressSelect.empty().append('<option value="">{{ text_select }}</option>');
      $.each(data, function(_, address) {
        addressSelect.append('<option value="' + address.street_id + '">' + address.name_ua + '</option>');
      });
      
      // Reinitialize Select2
      addressSelect.select2({
        placeholder: '{{ text_select }}',
        allowClear: true,
        width: '100%'
      });
      
      if ('{{ shipping_meest_express_sender_address }}') {
        addressSelect.val('{{ shipping_meest_express_sender_address }}').trigger('change');
      }
    }, 'json');
  }

  // Populate branches based on city
  function populateBranches(city_id) {
    $.get('{{ ajax_get_branches_url }}'.replace(/&amp;/g, '&'), { city_id: city_id }, function(data) {
      const branchSelect = $('#input-sender-branch');
      
      // Destroy Select2 before updating options
      if (branchSelect.hasClass("select2-hidden-accessible")) {
        branchSelect.select2('destroy');
      }
      
      branchSelect.empty().append('<option value="">{{ text_select }}</option>');
      $.each(data, function(_, branch) {
        branchSelect.append('<option value="' + branch.branch_id + '">' + branch.short_name + ' (' + branch.address_more_information + ')</option>');
      });
      
      // Reinitialize Select2
      branchSelect.select2({
        placeholder: '{{ text_select }}',
        allowClear: true,
        width: '100%'
      });
      
      if ('{{ shipping_meest_express_sender_branch }}') {
        branchSelect.val('{{ shipping_meest_express_sender_branch }}').trigger('change');
      }
    }, 'json');
  }
</script>

{{ footer }}